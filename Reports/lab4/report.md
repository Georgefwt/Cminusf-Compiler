# Lab4 实验报告
 陈俊驰 PB18000051 (队长)

 余卓然 PB18000095

## 实验要求
 根据cminus-f语义，修改 src/cminusfc/cminusf_builder.cpp 来实现自动 IR 产生的算法，使得它能正确编译任何合法的 cminus-f 程序，同时要求使用访问者模式来设计抽象语法树中的算法，将语法树翻译到正确的LLVM IR。


## 实验难点


1. 理解cminusf_builder.cpp中各模块内容的任务以及对应cminusf_builder.hpp中类的定义和继承，理解类之间的转换关系；

2. 阅读并理解助教所提供的各接口的作用及意义，明确其输入输出功能，并区分清楚其作用是否仅限于cminusf_builder.cpp是否会对于生成的LLVM IR文件中的代码行产生影响，例如是否会加入冗余的代码；

3. 如何在不同类型Node的遍历过程之间进行妥协与统一规范，使得在遵守编程范式的基础上，最大程度的减少不同结点之间的相互依赖和数据的传递，从而更好地实现模块化并保证化简程序；

4. 类型转换的特殊情况以及强制转换的处理，对于五处需要强制类型转换的位置如何处理；

5. 全局变量和局部变量的设计，如何在结点之间传递数据；

6. 全局数组和指针的使用和设计；

7. 对于BasicBlock的处理，如何保证每一个基本块都会有且仅有一个终止指令；



## 实验设计

请写明为了顺利完成本次实验，加入了哪些亮点设计，并对这些设计进行解释。
可能的阐述方向有:

1. 如何设计全局变量
2. 遇到的难点以及解决方案
3. 如何降低生成 IR 中的冗余
4. ...


本次实验中，对于该程序的整体框架，我们组将其自顶向下分为三层：第一层为声明定义层，包括Program、Vardeclaration、Fundeclaration、Param,本层主要负责对于函数、变量的定义；第二层为结构层，包括CompoundStmt、ExpressionStmt、SelectionStmt、IterationStmt、ReturnStmt，本层主要负责代码结构的处理，作为连接，一方面实现第一层函数中的具体内容，另一方面连接第三层中对于数据的具体运算与获得；第三层为数据层，包括Num、Var、AssignExpression、SimpleExpression、AdditiveExpression、Term、Call，本层负责对于数据进行具体的运算并传递给上一层的各种结构进行使用。分层的主要目的在于进行合理的任务分配，从而尽力保证相互依赖性最大的部分由同一个人处理，这样可以减少在于后期合并代码时不兼容的问题；此外，通过建立分层的框架能够更好理解代码结构，方便各部分功能理解以及参数传递。

以上为宏观角度的设计，在具体的实现过程中有以下的设计。

对于全局变量的设计，在最初讨论过程中我们组的目标是尽量减少各部分之间的使用全局变量的数据传递，由于访问者模式的要求，故不同部分之间仍不可避免的有数据的传递，故尽量将同类的数据在同一个变量中进行传递，最终通过合并且充分利用Value类作为诸多类的父类的特点，在具体实现中仅加入了两个全局变量为Value*类型的全局变量expression和var_location。其中expression的是用来存储值的，包括但不限于Num获得的结果、各类expression计算结果等；var_expression仅用于存储地址，包括变量、指针、数组地址的地址获得，仅在assign和call中被使用。仅用两个全局变量存储值和地址，大大的减少了空间消耗，增加了程序的可读性。

对于变量的声明与调用，声明中，充分利用scope类对于是否为全局作用域的判定，来区分全局和局部变量，从而避免了在Program部分声明全局变量；在调用时，由于不同情况下分别需要一个变量作为左值或者右值进行处理，故为了化简操作，统一用Var进行处理，无论何时调用Var，均用expression变量存储其值、var_location存储其地址，通过增加冗余操作来化简程序。

对于ret或br语句后，由于一个基本块不应当出现其他的终止语句，故应截断之后本基本块中三地址码的生成。在每一次向基本块中插入一个三地址码后，进行判断，这里巧妙地利用了BB中所提供的get_terminator接口，通过能否获得终结语句来判断是否该基本块应当截止。以if为例，对于真假分支，均当Compound部分不存在return才会有回到if结束的br语句，同时，若真假分支均不需要br到if结束则甚至不需要申请象征两支分支合并的merge基本块。

在本次实验中遇到最难的一个问题是对于指针和数组的处理问题，最初由于条件判断出错以及对于Value*的类型理解不当，导致多次进行修改，尝试了包括将数组Array转为指针Pointer等，最终，意识到该问题是由于对于Lab3中思考题不同getelementptr用法理解不够透彻以及对于alloc所返回是一个指针的认识不到位所导致。在该实验中无论是函数中取出的指针还是申请的数组，均为pointer，但其指针所指向的为int、float或者为一个array，通过对于指针指向的元素类型判定成功实现了对于数组与指针的区分。

对于类型转换，LLVM IR中可能会产生i32、i1、float三种类型的数值，为了减少在对于类型转换时所需要考虑的情况且满足cminusf不存在i1的特点，对于会产生i1的情况，例如simpleexpression中的比较，一旦出现i1，便立刻通过zext扩展为i32类型。此外，由于对于zext，sitofp，fptosi的不理解，导致我们组中间出现了大量的类型转换错误，最终通过阅读文档分析类型转换的轨迹成功理解并解决了该问题。对于各处的类型转换，首先判断是否类型不同，如果类型不同在判断目标为float还是i32，再进行转换。

对于IR中冗余的降低，主要在基本块生成方面，对于while语句，通过申请一个条件判断基本块，将是否进入循环、是否脱离循环的判断均转到该条件判断处，这样可以避免进入脱离循环重复书写相同的代码从而降低冗余；对于if语句，通过判断该if的真假分支是否均有br语句，从而来决定是否要有一个合并真假分支结果的基本块。



### 实验总结
在本次实验中，主要的难点在于读懂需求以及对于代码的特殊细节进行处理，在分工写代码之前查取了较多资料，结合GitHub类似实验、阅读各个头文件以及官方文档，并参照先前已有的gcd_generator得到书写代码的思路。其中，大量的时间在于阅读讨论语法以及各类接口的使用方式。

​分工完成各个子程序，每人负责一部分相互关联的子程序，提高了整体合作的效率。由于相互关联的子程序大多有同一个人处理，这样一方面便于对于整体的功能划分的把握，另一方面，由于结构相似性减少了理解的时间。此外，该种分工方式极大地减少了不同人所写程序间的连接，进而避免了很多不匹配导致的连接性错误。

在debug过程中尝试多种思路，集思广益发现了较多改进点。一方面，发现了许多个人写代码时发现不了的坏习惯以及不细心导致的错误；另一方面，在本次合作实验中，深刻的理解到了不同视角看问题的优越性，许多小细节的处理、bug的订正方式均是靠着大量的不同理解角度讨论获得的。在这次实验中真正的意识到了团队合作并不在于简单地分工提高效率，而在于讨论中的相互启发，，三个臭皮匠胜过诸葛亮，今后应着重进行讨论，分享思路。



### 实验反馈 （可选 不会评分）

对本次实验的建议

对于未来的实验十分建议助教像这次一样给出一个复杂例子以及详细的注释。读懂上次的gcd_generator.cpp对我理解相关知识以及上手书写起到了很大很大的帮助，依葫芦画瓢也快速帮我掌握了语句用法。
### 组间交流 （可选）

本次实验和哪些组（记录组长学号）交流了哪一部分信息
